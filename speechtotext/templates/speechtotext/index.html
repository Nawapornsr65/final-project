<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Speech-to-Text</title>
  <style>
    :root{
      --violet:#5a54f7; --violet-600:#4c45d6; --violet-700:#3f39b8;
      --bg:#eeeeF4;      /* ‡∏°‡∏∑‡∏î‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏° */
      --card:#ffffff; --text:#111827; --muted:#6b7280; --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:var(--bg);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center
    }
    .wrap{width:100%; max-width:980px; padding:32px}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 10px 35px rgba(31,41,55,.12);
      padding:28px;
      position:relative
    }
    h1{margin:0 0 18px; color:var(--violet)}

    /* Upload */
    .upload-row{display:flex; align-items:center; gap:10px}
    .filebox{
      flex:1; position:relative;
      display:flex; align-items:center; justify-content:space-between;
      border:1px solid #e5e7eb; border-radius:10px; background:#fff; padding-right:6px
    }
    .filebox input[type=file]{
      flex:1; padding:12px 14px; border:none; background:transparent; font-size:14px
    }
    .remove-file-btn{background:none; border:none; color:var(--muted); cursor:pointer; padding:0 8px}
    .remove-file-btn:hover{color:#ef4444}
    .send-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:56px; height:42px; border:none; border-radius:10px; cursor:pointer;
      background:linear-gradient(180deg,var(--violet),var(--violet-700));
      color:#fff; box-shadow:0 6px 16px rgba(90,84,247,.35)
    }

    /* Output */
    .outbox{margin-top:14px}
    textarea{
      width:100%; min-height:210px; resize:vertical;
      padding:14px; border:1px solid #e5e7eb; border-radius:10px;
      font-size:15px; line-height:1.5
    }
    .muted{color:var(--muted)}

    /* Player */
    .player{
      margin-top:20px; padding:16px;
      border:1px solid #eef0ff; border-radius:12px; background:#fafafe;
      position:relative; display:flex; flex-direction:column; gap:16px
    }
    .progress{display:flex; align-items:center; gap:12px}
    .time{font-variant-numeric:tabular-nums; color:var(--muted); font-size:14px; min-width:44px; text-align:center}
    #seekBar{
      flex:1; height:8px; appearance:none;
      background:linear-gradient(90deg,#eceefe,#f3f4ff);
      border-radius:999px; outline:none; box-shadow:inset 0 1px 2px rgba(0,0,0,.06)
    }
    #seekBar::-webkit-slider-thumb{
      appearance:none; width:16px; height:16px; border-radius:50%;
      background:var(--violet); box-shadow:0 2px 6px rgba(90,84,247,.35)
    }
    #seekBar::-moz-range-thumb{
      width:16px; height:16px; border:none; border-radius:50%; background:var(--violet)
    }

    .control-row{display:flex; align-items:center; justify-content:center; gap:40px; margin-top:8px}
    .icon-btn{
      appearance:none; background:#fff; border:1px solid #e5e7eb; border-radius:50%;
      width:54px; height:54px; cursor:pointer; color:#111;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      box-shadow:0 4px 12px rgba(0,0,0,.08); transition:all .2s
    }
    .icon-btn svg{width:22px; height:22px}
    .icon-btn span.label{font-size:12px; color:var(--muted); margin-top:4px}
    .icon-btn:hover{background:var(--violet); color:#fff; transform:translateY(-2px)}

    .volume{display:flex; align-items:center; gap:14px; margin-left:16px}
    .vol-btn{
      width:44px; height:44px; border-radius:50%;
      display:grid; place-items:center; border:1px solid #e5e7eb;
      background:#fff; box-shadow:0 2px 6px rgba(0,0,0,.08);
      cursor:pointer; transition:transform .18s ease, box-shadow .18s ease
    }
    .vol-btn:hover{background:var(--violet); color:#fff; transform:translateY(-1px)}
    .vol-btn svg{width:22px; height:22px; color:#3f3f46}
    #vol{
      width:160px; height:6px; appearance:none; background:#e5e7eb;
      border-radius:999px; outline:none; box-shadow:inset 0 1px 2px rgba(0,0,0,.06)
    }
    #vol::-webkit-slider-thumb{
      appearance:none; width:18px; height:18px; border-radius:50%;
      background:var(--violet); box-shadow:0 4px 10px rgba(90,84,247,.3)
    }
    #vol::-moz-range-thumb{
      width:18px; height:18px; border-radius:50%;
      background:var(--violet); border:none
    }

    .download-wrap{display:flex; justify-content:flex-end}
    .download-btn{
      background:var(--violet); color:#fff; border:none; border-radius:8px;
      padding:8px 14px; font-weight:600; cursor:pointer; box-shadow:0 4px 12px rgba(90,84,247,.35)
    }
    .download-btn:hover{background:var(--violet-600)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Speech-to-Text</h1>

      <!-- Upload -->
      <div class="upload-row">
        <div class="filebox" id="dropzone">
          <input type="file" id="audioFile" accept="audio/*,.m4a,.mp3,.wav,.ogg" />
          <button class="remove-file-btn" id="clearBtn" title="Remove file">√ó</button>
        </div>
        <button class="send-btn" id="sendBtn" title="Transcribe">Send</button>
      </div>

      <!-- Output -->
      <div class="outbox">
        <textarea id="output" placeholder="Your transcription will appear here‚Ä¶"></textarea>
        <div class="muted" id="status" style="margin-top:8px"></div>
      </div>

      <!-- Player -->
      <div class="player">
        <div class="progress">
          <span class="time" id="currentTime">0:00</span>
          <input type="range" id="seekBar" value="0" min="0" step="1">
          <span class="time" id="duration">0:00</span>
        </div>

        <div class="control-row">
          <button class="icon-btn" id="backBtn" aria-label="Back 10 seconds">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 7 4 12l8 5V7zm8 0-8 5 8 5V7z"/></svg>
            <span class="label">-10s</span>
          </button>
          <button class="icon-btn" id="playPauseBtn" aria-label="Play/Pause">
            <svg id="playIcon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            <svg id="pauseIcon" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>
          </button>
          <button class="icon-btn" id="skipBtn" aria-label="Forward 10 seconds">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 7v10l8-5-8-5zm8 0v10l8-5-8-5z"/></svg>
            <span class="label">+10s</span>
          </button>
          <div class="volume">
            <button class="vol-btn" id="muteBtn" aria-label="Mute">
              <svg id="volOn" viewBox="0 0 24 24" fill="currentColor"><path d="M4 10v4h4l5 4V6l-5 4H4z"/><path d="M16.5 8.5a5 5 0 0 1 0 7" opacity=".6"/><path d="M18.8 6.2a8 8 0 0 1 0 11.6" opacity=".35"/></svg>
              <svg id="volOff" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M4 10v4h4l5 4V6l-5 4H4z"/><path d="M19 5 5 19" stroke="currentColor" stroke-width="2"/></svg>
            </button>
            <input type="range" id="vol" min="0" max="1" step="0.01" value="1" />
          </div>
        </div>

        <div class="download-wrap">
          <button class="download-btn" id="downloadBtn">Download Text</button>
        </div>
      </div>

      <audio id="player" preload="metadata" style="display:none"></audio>
    </div>
  </div>

  <script>
    const fileInput=document.getElementById('audioFile');
    const clearBtn=document.getElementById('clearBtn');
    const sendBtn=document.getElementById('sendBtn');
    const output=document.getElementById('output');
    const statusEl=document.getElementById('status');
    const audioEl=document.getElementById('player');
    const seekBar=document.getElementById('seekBar');
    const currentTimeEl=document.getElementById('currentTime');
    const durationEl=document.getElementById('duration');
    const backBtn=document.getElementById('backBtn');
    const playPauseBtn=document.getElementById('playPauseBtn');
    const playIcon=document.getElementById('playIcon');
    const pauseIcon=document.getElementById('pauseIcon');
    const skipBtn=document.getElementById('skipBtn');
    const muteBtn=document.getElementById('muteBtn');
    const volOn=document.getElementById('volOn');
    const volOff=document.getElementById('volOff');
    const volSlider=document.getElementById('vol');
    const downloadBtn=document.getElementById('downloadBtn');
    let fileObjectUrl=null;

    function fmt(sec){
      if(!isFinite(sec)) return '0:00';
      const m=Math.floor(sec/60);
      const s=Math.floor(sec%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }
    function fmtMMSS(ms){
      const s=Math.floor(ms/1000);
      const m=Math.floor(s/60);
      const r=s%60;
      return `${m}:${String(r).padStart(2,'0')}`;
    }
    function setStatus(msg){ statusEl.textContent=msg||''; }

    fileInput.addEventListener('change',()=>{ 
      if(fileObjectUrl) URL.revokeObjectURL(fileObjectUrl); 
      if(fileInput.files[0]){ 
        fileObjectUrl=URL.createObjectURL(fileInput.files[0]); 
        audioEl.src=fileObjectUrl; 
        setStatus(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå: ${fileInput.files[0].name}`); 
      }
    });
    clearBtn.addEventListener('click',()=>{ 
      fileInput.value=''; 
      if(fileObjectUrl){ URL.revokeObjectURL(fileObjectUrl); fileObjectUrl=null; }
      audioEl.removeAttribute('src');
      output.value='';
      setStatus('');
      seekBar.value=0;
      currentTimeEl.textContent='0:00';
      durationEl.textContent='0:00';
      playIcon.style.display='block';
      pauseIcon.style.display='none';
    });

    audioEl.addEventListener('loadedmetadata',()=>{ 
      durationEl.textContent=fmt(audioEl.duration); 
      seekBar.max=Math.floor(audioEl.duration||0); 
    });
    audioEl.addEventListener('timeupdate',()=>{ 
      seekBar.value=Math.floor(audioEl.currentTime||0); 
      currentTimeEl.textContent=fmt(audioEl.currentTime||0); 
    });
    audioEl.addEventListener('ended',()=>{ 
      pauseIcon.style.display='none'; 
      playIcon.style.display='block'; 
    });

    seekBar.addEventListener('input',()=>{ audioEl.currentTime=+seekBar.value; });
    playPauseBtn.addEventListener('click',async()=>{ 
      if(audioEl.paused){ 
        await audioEl.play().catch(()=>{}); 
        playIcon.style.display='none'; 
        pauseIcon.style.display='block'; 
      } else { 
        audioEl.pause(); 
        playIcon.style.display='block'; 
        pauseIcon.style.display='none'; 
      } 
    });
    backBtn.addEventListener('click',()=>{ if(audioEl.duration){ audioEl.currentTime=Math.max(audioEl.currentTime-10,0); }});
    skipBtn.addEventListener('click',()=>{ if(audioEl.duration){ audioEl.currentTime=Math.min(audioEl.currentTime+10,audioEl.duration); }});
    volSlider.addEventListener('input',()=>{ 
      audioEl.volume=+volSlider.value; 
      const muted=audioEl.volume===0; 
      volOn.style.display= muted? 'none':'block'; 
      volOff.style.display= muted? 'block':'none'; 
    });
    muteBtn.addEventListener('click',()=>{ 
      if(audioEl.muted || audioEl.volume===0){ 
        audioEl.muted=false; 
        if(audioEl.volume===0){ audioEl.volume=0.6; volSlider.value=0.6; } 
        volOn.style.display='block'; 
        volOff.style.display='none'; 
      } else { 
        audioEl.muted=true; 
        volOn.style.display='none'; 
        volOff.style.display='block'; 
        volSlider.value=0; 
      } 
    });

    downloadBtn.addEventListener('click',()=>{ 
      const blob=new Blob([output.value||''],{type:'text/plain'}); 
      const url=URL.createObjectURL(blob); 
      const a=document.createElement('a'); 
      a.href=url; a.download='transcription.txt'; 
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); 
    });

    // üî¥ ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô statusEl ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    sendBtn.addEventListener('click', async ()=> {
      if(!fileInput.files[0]){ setStatus('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô'); return; }

      let start = Date.now();
      setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ñ‡∏≠‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‚Ä¶ (0:00)');
      const timer = setInterval(()=>{
        const ms = Date.now() - start;
        statusEl.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ñ‡∏≠‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‚Ä¶ (${fmtMMSS(ms)})`;
      }, 500);

      const formData=new FormData();
      formData.append("file", fileInput.files[0]);

      try{
        const res = await fetch("/api/speech-to-text/", { method: "POST", body: formData });
        const raw = await res.text();
        let data;
        try { data = JSON.parse(raw); } catch { data = null; }

        clearInterval(timer);

        if(!res.ok || !data){
          output.value = data ? JSON.stringify(data, null, 2) : raw;
          setStatus(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (${res.status})`);
          return;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ segments (‡∏û‡∏£‡πâ‡∏≠‡∏° speaker) ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
        const segs = Array.isArray(data.segments) ? data.segments : [];
        if(segs.length){
          const lines = segs.map(seg=>{
            const spk = seg.speaker ? `‡∏ú‡∏π‡πâ‡∏û‡∏π‡∏î‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${seg.speaker}: ` : '';
            return `${spk}${seg.text}`;
          });
          output.value = lines.join('\n');
        }else if(data.text){
          output.value = data.text;
        }else{
          output.value = JSON.stringify(data, null, 2);
        }

        // ‡πÄ‡∏ß‡∏•‡∏≤: ‡πÉ‡∏ä‡πâ seconds_spent ‡∏à‡∏≤‡∏Å backend ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ / ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡πÉ‡∏ä‡πâ client timer
        const sec = (typeof data.seconds_spent==='number' && isFinite(data.seconds_spent))
          ? data.seconds_spent
          : Math.round((Date.now()-start)/1000);

        const mm = Math.floor(sec/60), ss = String(Math.round(sec%60)).padStart(2,'0');
        const diarFlag = data.diarization_enabled ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î';
        setStatus(`‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (${mm}:${ss}) ‚Ä¢ Diarization: ${diarFlag}`);
      }catch(e){
        clearInterval(timer);
        console.error(e);
        setStatus('‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    });
  </script>
</body>
</html>
